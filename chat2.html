<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>DECOHERENCEXXIII - Formaci√≥n Planetaria</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
            overflow: hidden;
            background: #ffffff;
            margin: 0;
            padding: 0;
        }
        
        #simulationCanvas {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            z-index: 1;
            background: #ffffff;
        }
        
        /* CHAT MINIMALISTA - OCUPA POCO ESPACIO */
        .chat-sidebar {
            position: fixed;
            bottom: 20px;
            right: 20px;
            width: 320px;
            max-height: 70vh;
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(20px);
            border: 1px solid rgba(0,0,0,0.08);
            border-radius: 16px;
            z-index: 10;
            display: flex;
            flex-direction: column;
            box-shadow: 0 10px 40px rgba(0,0,0,0.08);
            transition: all 0.3s ease;
            overflow: hidden;
        }
        
        .chat-sidebar.minimized {
            height: auto;
            max-height: 60px;
            overflow: hidden;
        }
        
        .message-bubble {
            max-width: 90%;
            animation: fadeIn 0.3s ease-out;
            font-size: 12px;
            line-height: 1.4;
        }
        
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(5px); }
            to { opacity: 1; transform: translateY(0); }
        }
        
        .option-btn {
            transition: all 0.15s ease;
            border: 1px solid transparent;
            font-size: 11px;
            padding: 6px 10px;
        }
        
        .option-btn:hover {
            background: rgba(26, 26, 26, 0.06);
            border-color: rgba(26, 26, 26, 0.15);
            transform: translateX(2px);
        }
        
        .typing-dot {
            animation: typing 1.4s infinite ease-in-out both;
        }
        
        .typing-dot:nth-child(1) { animation-delay: -0.32s; }
        .typing-dot:nth-child(2) { animation-delay: -0.16s; }
        
        @keyframes typing {
            0%, 80%, 100% { transform: scale(0); opacity: 0.5; }
            40% { transform: scale(1); opacity: 1; }
        }
        
        /* √ÅREA DE MENSAJES CON SCROLL INDEPENDIENTE */
        .chat-messages {
            flex: 1;
            overflow-y: auto;
            overflow-x: hidden;
            min-height: 0;
            max-height: 40vh;
            scrollbar-width: thin;
            scrollbar-color: rgba(0,0,0,0.1) transparent;
        }
        
        .chat-messages::-webkit-scrollbar {
            width: 4px;
        }
        
        .chat-messages::-webkit-scrollbar-track {
            background: transparent;
        }
        
        .chat-messages::-webkit-scrollbar-thumb {
            background-color: rgba(0,0,0,0.1);
            border-radius: 20px;
        }
        
        /* √ÅREA DE OPCIONES CON SCROLL SI ES NECESARIO */
        .options-area {
            max-height: 25vh;
            overflow-y: auto;
            overflow-x: hidden;
            border-top: 1px solid rgba(0,0,0,0.06);
            background: rgba(255,255,255,0.5);
            scrollbar-width: thin;
            scrollbar-color: rgba(0,0,0,0.1) transparent;
        }
        
        .options-area::-webkit-scrollbar {
            width: 4px;
        }
        
        .options-area::-webkit-scrollbar-track {
            background: transparent;
        }
        
        .options-area::-webkit-scrollbar-thumb {
            background-color: rgba(0,0,0,0.1);
            border-radius: 20px;
        }
        
        /* Bot√≥n flotante minimalista */
        #restoreBtn {
            position: fixed;
            bottom: 20px;
            right: 20px;
            width: 50px;
            height: 50px;
            background: rgba(26, 26, 26, 0.9);
            color: white;
            border-radius: 50%;
            border: none;
            cursor: pointer;
            z-index: 20;
            display: none;
            align-items: center;
            justify-content: center;
            box-shadow: 0 4px 15px rgba(0,0,0,0.2);
            transition: all 0.3s ease;
        }
        
        #restoreBtn:hover {
            transform: scale(1.1);
            background: rgba(26, 26, 26, 1);
        }
        
        @media (max-width: 768px) {
            .chat-sidebar {
                width: calc(100% - 40px);
                right: 20px;
                left: 20px;
                bottom: 20px;
                max-height: 60vh;
            }
            
            .chat-messages {
                max-height: 30vh;
            }
            
            .options-area {
                max-height: 20vh;
            }
        }
        
        .stats-panel {
            position: fixed;
            top: 20px;
            left: 20px;
            z-index: 5;
            background: rgba(255,255,255,0.9);
            backdrop-filter: blur(10px);
            padding: 10px 14px;
            border-radius: 10px;
            border: 1px solid rgba(0,0,0,0.06);
            font-size: 10px;
            color: #666;
            font-family: 'Inter', monospace;
            pointer-events: none;
            line-height: 1.4;
        }
        
        .legend-panel {
            position: fixed;
            top: 20px;
            right: 360px;
            z-index: 5;
            background: rgba(255,255,255,0.9);
            backdrop-filter: blur(10px);
            padding: 10px 14px;
            border-radius: 10px;
            border: 1px solid rgba(0,0,0,0.06);
            font-size: 10px;
            color: #666;
            pointer-events: none;
            line-height: 1.4;
        }
        
        @media (max-width: 1100px) {
            .legend-panel {
                right: 340px;
                top: 80px;
            }
        }
        
        @media (max-width: 768px) {
            .legend-panel {
                right: 20px;
                top: 80px;
                left: auto;
            }
        }
    </style>
</head>
<body class="bg-white">

    <!-- Canvas de Simulaci√≥n - OCUPA TODA LA PANTALLA -->
    <canvas id="simulationCanvas"></canvas>
    
    <!-- Stats Panel -->
    <div class="stats-panel">
        <div>Part√≠culas: <span id="particleCount">0</span></div>
        <div>Atractoras: <span id="attractorCount">0</span></div>
        <div>Repulsivas: <span id="repulsorCount">0</span></div>
        <div>Colisiones: <span id="collisionCount">0</span></div>
    </div>
    
    <!-- Leyenda de colores -->
    <div class="legend-panel">
        <div style="display: flex; align-items: center; gap: 6px; margin-bottom: 4px;">
            <span style="width: 8px; height: 8px; background: #1a1a1a; border-radius: 50%; display: inline-block;"></span>
            <span>Atractoras (gravedad)</span>
        </div>
        <div style="display: flex; align-items: center; gap: 6px;">
            <span style="width: 8px; height: 8px; background: #dc2626; border-radius: 50%; display: inline-block;"></span>
            <span>Repulsivas (anti-gravedad)</span>
        </div>
    </div>

    <!-- Chat Sidebar - MINIMALISTA -->
    <div class="chat-sidebar" id="chatSidebar">
        <!-- Header Compacto -->
        <div class="px-4 py-3 border-b border-gray-100 flex items-center justify-between bg-white/50 cursor-pointer" onclick="toggleChat()">
            <div class="flex items-center space-x-2">
                <div class="w-6 h-6 bg-neutral-900 rounded-md flex items-center justify-center text-white text-[10px] font-bold tracking-wider">
                    D23
                </div>
                <div>
                    <h1 class="font-semibold text-gray-900 text-xs tracking-tight">DECOHERENCEXXIII</h1>
                    <p class="text-[10px] text-gray-500 flex items-center gap-1 mt-0.5">
                        <span class="w-1 h-1 bg-emerald-500 rounded-full animate-pulse"></span>
                        Online
                    </p>
                </div>
            </div>
            <button class="text-gray-400 hover:text-gray-600 transition p-1" onclick="event.stopPropagation(); minimizeChat()">
                <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path>
                </svg>
            </button>
        </div>

        <!-- Messages Area - CON SCROLL INDEPENDIENTE -->
        <div id="chatMessages" class="chat-messages px-4 py-3 space-y-2">
            <!-- Mensajes din√°micos -->
        </div>

        <!-- Options Area - CON SCROLL INDEPENDIENTE -->
        <div class="options-area px-4 py-3">
            <div id="optionsContainer" class="space-y-1">
                <!-- Opciones din√°micas -->
            </div>
        </div>
    </div>

    <!-- Bot√≥n flotante para restaurar chat -->
    <button id="restoreBtn" onclick="restoreChat()">
        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 12h.01M12 12h.01M16 12h.01M21 12c0 4.418-4.03 8-9 8a9.863 9.863 0 01-4.255-.949L3 20l1.395-3.72C3.512 15.042 3 13.574 3 12c0-4.418 4.03-8 9-8s9 3.582 9 8z"></path>
        </svg>
    </button>

    <script>
        // ==========================================
        // SIMULACI√ìN DE F√çSICA DE PART√çCULAS MEJORADA
        // DECOHERENCEXXIII - Espect√°culo de Formaci√≥n Planetaria
        // ==========================================
        const PHYSICS = {
            N_ATTRACTORS: 200,        // M√°s part√≠culas para mayor densidad
            N_REPULSORS: 1,          // M√°s repulsores para dinamismo
            G_ATTRACT: 3.5,           // Gravedad m√°s fuerte
            G_REPULSE: -2.5,          // Anti-gravedad m√°s intensa
            sigma: 0.12,              // Ruido t√©rmico aumentado
            dt: 0.25,
            v_coalescencia: 3,      // Umbral m√°s alto para m√°s coalisiones
            v_fragmentacion: 6,       // Umbral m√°s bajo para m√°s fragmentaciones
            restitucion: 0.4,
            minRadius: 2,
            maxRadius: 35,            // Planetas m√°s grandes posibles
            minMass: 0.8,
            fragmentos: 4,            // M√°s fragmentos al romper
            trailLength: 50,          // Estelas m√°s largas
            connectionDistance: 120,  // Distancia para l√≠neas de conexi√≥n
            mouseRepelRadius: 150,    // Radio de repulsi√≥n del mouse
            mouseRepelForce: 80       // Fuerza de repulsi√≥n del mouse
        };

        let width, height;
        const particles = [];
        let collisionCounter = 0;
        let mouse = { x: -1000, y: -1000, active: false };
        let frameCount = 0;
        
        class Planetesimal {
            constructor(type, x, y, m, vx, vy) {
                this.type = type || (Math.random() > 0.85 ? 'repulsor' : 'attractor');
                
                // Distribuci√≥n en espiral gal√°ctica inicial
                if (x === undefined || y === undefined) {
                    const arm = Math.floor(Math.random() * 2); // 2 brazos espirales
                    const angle = (Math.random() * Math.PI * 2) + (arm * Math.PI);
                    const r = Math.random() * Math.min(width, height) * 0.45;
                    // A√±adir dispersi√≥n aleatoria
                    const scatter = (Math.random() - 0.5) * 100;
                    this.x = width/2 + Math.cos(angle) * r + scatter;
                    this.y = height/2 + Math.sin(angle) * r + scatter;
                } else {
                    this.x = x;
                    this.y = y;
                }
                
                // Distribuci√≥n de masa con ley de potencias (m√°s realista)
                if (m === undefined) {
                    const rand = Math.random();
                    if (rand < 0.7) {
                        // 70% peque√±as (polvo)
                        this.mass = PHYSICS.minMass + Math.random() * 3;
                    } else if (rand < 0.95) {
                        // 25% medianas (asteroides)
                        this.mass = 3 + Math.random() * 8;
                    } else {
                        // 5% grandes (planetas)
                        this.mass = 10 + Math.random() * 20;
                    }
                } else {
                    this.mass = Math.max(m, PHYSICS.minMass);
                }
                
                // Velocidad orbital inicial con componente aleatorio
                if (vx === undefined || vy === undefined) {
                    const dx = this.x - width/2;
                    const dy = this.y - height/2;
                    const r = Math.sqrt(dx*dx + dy*dy) + 1;
                    
                    // Velocidad orbital kepleriana con perturbaci√≥n
                    const centralMass = this.type === 'attractor' ? 100 : -50;
                    const v_orbital = Math.sqrt(Math.abs(PHYSICS.G_ATTRACT * centralMass) / r);
                    const direction = this.type === 'attractor' ? 1 : -1;
                    
                    // A√±adir inclinaci√≥n aleatoria para √≥rbitas el√≠pticas
                    const eccentricity = 0.3;
                    this.vx = (dy / r) * v_orbital * direction * (1 + (Math.random()-0.5)*eccentricity);
                    this.vy = -(dx / r) * v_orbital * direction * (1 + (Math.random()-0.5)*eccentricity);
                    
                    // A√±adir velocidad radial inicial para espiral
                    this.vx += (dx/r) * 0.2;
                    this.vy += (dy/r) * 0.2;
                } else {
                    this.vx = vx;
                    this.vy = vy;
                }
                
                this.radius = this.calcRadius();
                // Colores seg√∫n tipo y masa
                this.updateColor();
                this.orbitalTrail = [];
                this.maxTrail = PHYSICS.trailLength;
                this.G = this.type === 'attractor' ? PHYSICS.G_ATTRACT : PHYSICS.G_REPULSE;
                this.age = 0;
                this.pulsePhase = Math.random() * Math.PI * 2;
            }
            
            calcRadius() {
                // Radio proporcional a ra√≠z c√∫bica de la masa (f√≠sica real)
                const r = Math.pow(this.mass, 1/2.5) * 2.2;
                return Math.max(PHYSICS.minRadius, Math.min(r, PHYSICS.maxRadius));
            }
            
            updateRadius() {
                this.radius = this.calcRadius();
                this.updateColor();
            }
            
            updateColor() {
                // Gradaci√≥n de color seg√∫n masa
                if (this.type === 'attractor') {
                    const intensity = Math.min(this.mass / 15, 1);
                    const gray = Math.floor(26 + (1-intensity) * 60);
                    this.color = `rgb(${gray}, ${gray}, ${gray})`;
                    this.glowColor = `rgba(26, 26, 26, ${0.1 + intensity * 0.2})`;
                } else {
                    // Repulsores en rojo con intensidad variable
                    const intensity = Math.min(this.mass / 10, 1);
                    const red = 220 + Math.floor((1-intensity) * 35);
                    this.color = `rgb(${red}, 38, 38)`;
                    this.glowColor = `rgba(220, 38, 38, ${0.15 + intensity * 0.25})`;
                }
            }
            
            canFragment() {
                const massPerFragment = this.mass / PHYSICS.fragmentos;
                return massPerFragment >= PHYSICS.minMass;
            }
            
            applyPeriodicBoundary() {
                let wrapped = false;
                if (this.x > width) { this.x -= width; wrapped = true; }
                else if (this.x < 0) { this.x += width; wrapped = true; }
                
                if (this.y > height) { this.y -= height; wrapped = true; }
                else if (this.y < 0) { this.y += height; wrapped = true; }
                
                if (wrapped) {
                    // Fade out trail al cruzar bordes
                    this.orbitalTrail = this.orbitalTrail.slice(-5);
                }
            }
            
            getPeriodicDistance(other) {
                let dx = other.x - this.x;
                let dy = other.y - this.y;
                
                // Condiciones peri√≥dicas de contorno (toroide)
                if (dx > width / 2) dx -= width;
                if (dx < -width / 2) dx += width;
                if (dy > height / 2) dy -= height;
                if (dy < -height / 2) dy += height;
                
                const dist = Math.sqrt(dx*dx + dy*dy);
                return { dx, dy, dist };
            }
            
            applyMouseForce() {
                if (!mouse.active) return;
                
                let dx = this.x - mouse.x;
                let dy = this.y - mouse.y;
                const dist = Math.sqrt(dx*dx + dy*dy);
                
                if (dist < PHYSICS.mouseRepelRadius && dist > 0) {
                    const force = PHYSICS.mouseRepelForce * (1 - dist/PHYSICS.mouseRepelRadius);
                    const fx = (dx/dist) * force / this.mass;
                    const fy = (dy/dist) * force / this.mass;
                    this.vx += fx * PHYSICS.dt;
                    this.vy += fy * PHYSICS.dt;
                }
            }
            
            gravitationalForce(other) {
                const periodic = this.getPeriodicDistance(other);
                const dx = periodic.dx;
                const dy = periodic.dy;
                const dist = periodic.dist;
                
                // Suavizado para evitar singularidades
                const epsilon = 8;
                const effectiveDist = Math.sqrt(dist*dist + epsilon*epsilon);
                
                if (effectiveDist < 0.1) return { fx: 0, fy: 0, dist: 0 };
                
                // Fuerza gravitacional con suavizado
                const G_eff = (this.G + other.G) / 2;
                const F = (G_eff * this.mass * other.mass) / (effectiveDist * effectiveDist);
                
                // Atracci√≥n/repulsi√≥n suavizada cerca del centro
                const softening = Math.min(1, effectiveDist / 50);
                
                return {
                    fx: F * (dx / effectiveDist) * softening,
                    fy: F * (dy / effectiveDist) * softening,
                    dist: dist
                };
            }
            
            update(allParticles) {
                this.age++;
                
                // Calcular fuerzas gravitacionales
                let Fx = 0, Fy = 0;
                
                // Fuerza hacia el centro (gravedad del "agujero negro" central)
                const dxCenter = width/2 - this.x;
                const dyCenter = height/2 - this.y;
                const distCenter = Math.sqrt(dxCenter*dxCenter + dyCenter*dyCenter);
                const centralForce = 0.5 * this.mass / (distCenter + 100);
                Fx += dxCenter * centralForce * 0.01;
                Fy += dyCenter * centralForce * 0.01;
                
                // Interacci√≥n con otras part√≠culas (optimizaci√≥n: solo cercanas)
                for (let other of allParticles) {
                    if (other === this) continue;
                    const force = this.gravitationalForce(other);
                    if (force.dist < 200) { // Solo part√≠culas cercanas
                        Fx += force.fx;
                        Fy += force.fy;
                    }
                }
                
                // Aceleraci√≥n
                const ax = Fx / this.mass;
                const ay = Fy / this.mass;
                
                // Ruido t√©rmico (movimiento browniano)
                const noiseScale = PHYSICS.sigma * Math.sqrt(PHYSICS.dt);
                const dWx = (Math.random() - 0.5) * noiseScale * 2;
                const dWy = (Math.random() - 0.5) * noiseScale * 2;
                
                // Actualizar velocidad
                this.vx += ax * PHYSICS.dt + dWx;
                this.vy += ay * PHYSICS.dt + dWy;
                
                // Amortiguaci√≥n muy ligera (fricci√≥n del medio)
                this.vx *= 0.9995;
                this.vy *= 0.9995;
                
                // Aplicar fuerza del mouse
                this.applyMouseForce();
                
                // Actualizar posici√≥n
                this.x += this.vx * PHYSICS.dt;
                this.y += this.vy * PHYSICS.dt;
                
                // Condiciones de contorno peri√≥dicas
                this.applyPeriodicBoundary();
                
                // Actualizar estela orbital
                if (this.age % 2 === 0) { // Muestrear cada 2 frames
                    this.orbitalTrail.push({
                        x: this.x, 
                        y: this.y,
                        vx: this.vx,
                        vy: this.vy
                    });
                    if (this.orbitalTrail.length > this.maxTrail) {
                        this.orbitalTrail.shift();
                    }
                }
            }
            
            draw(ctx) {
                const positions = this.getRenderPositions();
                
                positions.forEach(pos => {
                    // Dibujar estela orbital con gradiente
                    if (this.orbitalTrail.length > 2) {
                        ctx.save();
                        ctx.beginPath();
                        
                        for (let i = 0; i < this.orbitalTrail.length - 1; i++) {
                            const p1 = this.orbitalTrail[i];
                            const p2 = this.orbitalTrail[i+1];
                            
                            // Verificar continuidad (no conectar si salto es muy grande)
                            const dist = Math.sqrt((p2.x-p1.x)**2 + (p2.y-p1.y)**2);
                            
                            if (dist < 50) {
                                ctx.moveTo(p1.x, p1.y);
                                ctx.lineTo(p2.x, p2.y);
                            }
                        }
                        
                        // Gradientes de estela seg√∫n tipo
                        const gradient = ctx.createLinearGradient(
                            this.orbitalTrail[0].x, this.orbitalTrail[0].y,
                            pos.x, pos.y
                        );
                        
                        if (this.type === 'attractor') {
                            gradient.addColorStop(0, 'rgba(26, 26, 26, 0)');
                            gradient.addColorStop(1, 'rgba(26, 26, 26, 0.15)');
                        } else {
                            gradient.addColorStop(0, 'rgba(220, 38, 38, 0)');
                            gradient.addColorStop(1, 'rgba(220, 38, 38, 0.2)');
                        }
                        
                        ctx.strokeStyle = gradient;
                        ctx.lineWidth = Math.max(0.5, this.radius * 0.15);
                        ctx.lineCap = 'round';
                        ctx.stroke();
                        ctx.restore();
                    }
                    
                    // Dibujar glow para masas grandes
                    if (this.mass > 5) {
                        const glowRadius = this.radius * 2;
                        const gradient = ctx.createRadialGradient(
                            pos.x, pos.y, 0,
                            pos.x, pos.y, glowRadius
                        );
                        gradient.addColorStop(0, this.glowColor);
                        gradient.addColorStop(1, 'rgba(255,255,255,0)');
                        
                        ctx.fillStyle = gradient;
                        ctx.beginPath();
                        ctx.arc(pos.x, pos.y, glowRadius, 0, Math.PI * 2);
                        ctx.fill();
                    }
                    
                    // Dibujar cuerpo principal
                    ctx.beginPath();
                    ctx.arc(pos.x, pos.y, this.radius, 0, Math.PI * 2);
                    ctx.fillStyle = this.color;
                    ctx.fill();
                    
                    // Borde sutil
                    ctx.strokeStyle = this.type === 'attractor' 
                        ? 'rgba(0,0,0,0.3)' 
                        : 'rgba(180,30,30,0.4)';
                    ctx.lineWidth = 0.8;
                    ctx.stroke();
                    
                    // N√∫cleo brillante para planetas grandes
                    if (this.mass > 8) {
                        const coreRadius = this.radius * 0.3;
                        const coreGradient = ctx.createRadialGradient(
                            pos.x - this.radius*0.2, pos.y - this.radius*0.2, 0,
                            pos.x, pos.y, coreRadius
                        );
                        coreGradient.addColorStop(0, 'rgba(255,255,255,0.9)');
                        coreGradient.addColorStop(0.5, 'rgba(255,255,255,0.3)');
                        coreGradient.addColorStop(1, 'rgba(255,255,255,0)');
                        
                        ctx.beginPath();
                        ctx.arc(pos.x, pos.y, coreRadius, 0, Math.PI * 2);
                        ctx.fillStyle = coreGradient;
                        ctx.fill();
                    }
                    
                    // Pulso para repulsores
                    if (this.type === 'repulsor') {
                        const pulseRadius = this.radius * (1.5 + Math.sin(this.age * 0.1 + this.pulsePhase) * 0.3);
                        ctx.beginPath();
                        ctx.arc(pos.x, pos.y, pulseRadius, 0, Math.PI * 2);
                        ctx.strokeStyle = `rgba(220, 38, 38, ${0.1 + Math.sin(this.age * 0.1) * 0.05})`;
                        ctx.lineWidth = 1;
                        ctx.stroke();
                    }
                });
            }
            
            getRenderPositions() {
                const positions = [{x: this.x, y: this.y}];
                const threshold = this.radius + 15;
                
                // Renderizar copias peri√≥dicas para efecto continuo
                const offsets = [
                    [width, 0], [-width, 0],
                    [0, height], [0, -height],
                    [width, height], [-width, -height],
                    [width, -height], [-width, height]
                ];
                
                offsets.forEach(([ox, oy]) => {
                    if (this.x + ox < width + threshold && this.x + ox > -threshold &&
                        this.y + oy < height + threshold && this.y + oy > -threshold) {
                        positions.push({x: this.x + ox, y: this.y + oy});
                    }
                });
                
                return positions;
            }
        }

        function handleCollisions() {
            for (let i = particles.length - 1; i >= 0; i--) {
                for (let j = i - 1; j >= 0; j--) {
                    const p1 = particles[i];
                    const p2 = particles[j];
                    const periodic = p1.getPeriodicDistance(p2);
                    const dist = periodic.dist;
                    const minDist = p1.radius + p2.radius;
                    
                    if (dist < minDist) {
                        collisionCounter++;
                        const dvx = p2.vx - p1.vx;
                        const dvy = p2.vy - p1.vy;
                        const v_rel = Math.sqrt(dvx*dvx + dvy*dvy);
                        
                        // Coalescencia (misma tipo, baja velocidad relativa)
                        if (p1.type === p2.type && v_rel < PHYSICS.v_coalescencia) {
                            mergeParticles(i, j);
                            return; // Reiniciar loop tras modificar array
                        }
                        // Fragmentaci√≥n (alta velocidad, masas suficientes)
                        else if (v_rel >= PHYSICS.v_fragmentacion && p1.canFragment() && p2.canFragment()) {
                            const combinedMass = p1.mass + p2.mass;
                            if (combinedMass / PHYSICS.fragmentos >= PHYSICS.minMass) {
                                fragmentParticles(i, j);
                                return;
                            } else {
                                inelasticBounce(p1, p2, dist, 0.1);
                            }
                        }
                        // Rebote inel√°stico
                        else {
                            inelasticBounce(p1, p2, dist, PHYSICS.restitucion);
                        }
                    }
                }
            }
        }
        
        function mergeParticles(idx1, idx2) {
            const p1 = particles[idx1];
            const p2 = particles[idx2];
            const periodic = p1.getPeriodicDistance(p2);
            
            // Conservaci√≥n de momento
            const newMass = p1.mass + p2.mass;
            const newVx = (p1.mass * p1.vx + p2.mass * p2.vx) / newMass;
            const newVy = (p1.mass * p1.vy + p2.mass * p2.vy) / newMass;
            
            // Posici√≥n ponderada por masa
            let newX = p1.x + periodic.dx * (p2.mass / newMass);
            let newY = p1.y + periodic.dy * (p2.mass / newMass);
            newX = ((newX % width) + width) % width;
            newY = ((newY % height) + height) % height;
            
            // Tipo dominante por masa
            const dominantType = p1.mass > p2.mass ? p1.type : p2.type;
            
            // Crear part√≠cula fusionada con estela combinada
            const merged = new Planetesimal(dominantType, newX, newY, newMass, newVx, newVy);
            merged.orbitalTrail = [...p1.orbitalTrail.slice(-10), ...p2.orbitalTrail.slice(-10)];
            
            particles.splice(Math.max(idx1, idx2), 1);
            particles.splice(Math.min(idx1, idx2), 1);
            particles.push(merged);
        }
        
        function inelasticBounce(p1, p2, dist, restitutionCoeff) {
            const periodic = p1.getPeriodicDistance(p2);
            const nx = periodic.dx / (dist + 0.1);
            const ny = periodic.dy / (dist + 0.1);
            
            const dvx = p2.vx - p1.vx;
            const dvy = p2.vy - p1.vy;
            const vn = dvx * nx + dvy * ny;
            
            if (vn > 0) return; // Ya se separan
            
            const impulse = -(1 + restitutionCoeff) * vn / (1/p1.mass + 1/p2.mass);
            
            p1.vx -= impulse * nx / p1.mass;
            p1.vy -= impulse * ny / p1.mass;
            p2.vx += impulse * nx / p2.mass;
            p2.vy += impulse * ny / p2.mass;
            
            // Separar para evitar solapamiento
            const overlap = (p1.radius + p2.radius - dist) / 2 + 1;
            p1.x -= overlap * nx;
            p1.y -= overlap * ny;
            p2.x += overlap * nx;
            p2.y += overlap * ny;
            
            p1.applyPeriodicBoundary();
            p2.applyPeriodicBoundary();
        }
        
        function fragmentParticles(idx1, idx2) {
            const p1 = particles[idx1];
            const p2 = particles[idx2];
            const periodic = p1.getPeriodicDistance(p2);
            const totalMass = p1.mass + p2.mass;
            
            // Centro de masa
            let centerX = p1.x + periodic.dx * (p2.mass / totalMass);
            let centerY = p1.y + periodic.dy * (p2.mass / totalMass);
            centerX = ((centerX % width) + width) % width;
            centerY = ((centerY % height) + height) % height;
            
            // Velocidad del centro de masa
            const cmVx = (p1.mass * p1.vx + p2.mass * p2.vx) / totalMass;
            const cmVy = (p1.mass * p1.vy + p2.mass * p2.vy) / totalMass;
            
            // Calcular fragmentos viables
            const maxFragments = Math.floor(totalMass / PHYSICS.minMass);
            const nFragments = Math.min(PHYSICS.fragmentos, Math.max(3, maxFragments));
            
            if (nFragments < 2) {
                inelasticBounce(p1, p2, Math.sqrt(periodic.dx**2 + periodic.dy**2), 0.1);
                return;
            }
            
            particles.splice(Math.max(idx1, idx2), 1);
            particles.splice(Math.min(idx1, idx2), 1);
            
            const massPerFragment = totalMass / nFragments;
            const dominantType = p1.mass > p2.mass ? p1.type : p2.type;
            
            // Crear fragmentos en explosi√≥n radial
            for (let k = 0; k < nFragments; k++) {
                const angle = (Math.PI * 2 * k) / nFragments + Math.random() * 0.5;
                const speed = 1.5 + Math.random() * 2.5;
                const vx = cmVx + Math.cos(angle) * speed;
                const vy = cmVy + Math.sin(angle) * speed;
                
                const dist = 8 + Math.random() * 12;
                let fx = centerX + Math.cos(angle) * dist;
                let fy = centerY + Math.sin(angle) * dist;
                fx = ((fx % width) + width) % width;
                fy = ((fy % height) + height) % height;
                
                const fragmentMass = Math.max(massPerFragment * (0.8 + Math.random() * 0.4), PHYSICS.minMass);
                const fragment = new Planetesimal(dominantType, fx, fy, fragmentMass, vx, vy);
                fragment.orbitalTrail = [{x: fx, y: fy}]; // Estela fresca
                particles.push(fragment);
            }
        }

        // Dibujar l√≠neas de conexi√≥n entre part√≠culas cercanas (efecto constelaci√≥n)
        function drawConnections(ctx) {
            ctx.save();
            const maxConnections = 3; // L√≠neas por part√≠cula
            
            for (let i = 0; i < particles.length; i++) {
                const p1 = particles[i];
                let connections = 0;
                
                for (let j = i + 1; j < particles.length && connections < maxConnections; j++) {
                    const p2 = particles[j];
                    const periodic = p1.getPeriodicDistance(p2);
                    
                    if (periodic.dist < PHYSICS.connectionDistance && p1.type === p2.type) {
                        const alpha = (1 - periodic.dist / PHYSICS.connectionDistance) * 0.15;
                        
                        ctx.beginPath();
                        ctx.moveTo(p1.x, p1.y);
                        ctx.lineTo(p1.x + periodic.dx, p1.y + periodic.dy);
                        ctx.strokeStyle = p1.type === 'attractor' 
                            ? `rgba(26, 26, 26, ${alpha})`
                            : `rgba(220, 38, 38, ${alpha})`;
                        ctx.lineWidth = 0.5;
                        ctx.stroke();
                        
                        connections++;
                    }
                }
            }
            ctx.restore();
        }

        // Dibujar campo gravitacional sutil
        function drawField(ctx) {
            ctx.save();
            const gridSize = 80;
            const time = frameCount * 0.02;
            
            for (let x = 0; x < width; x += gridSize) {
                for (let y = 0; y < height; y += gridSize) {
                    // Calcular campo en este punto
                    let fx = 0, fy = 0;
                    
                    // Fuerza central
                    const dx = x - width/2;
                    const dy = y - height/2;
                    const dist = Math.sqrt(dx*dx + dy*dy) + 100;
                    fx -= dx / dist * 2;
                    fy -= dy / dist * 2;
                    
                    // Fuerzas de part√≠culas cercanas
                    particles.forEach(p => {
                        const pdx = x - p.x;
                        const pdy = y - p.y;
                        const pdist = Math.sqrt(pdx*pdx + pdy*pdy) + 50;
                        const f = p.G * p.mass / (pdist * pdist);
                        fx += (pdx/pdist) * f;
                        fy += (pdy/pdist) * f;
                    });
                    
                    // Normalizar y dibujar
                    const fmag = Math.sqrt(fx*fx + fy*fy);
                    if (fmag > 0.1) {
                        const scale = Math.min(15, fmag * 5);
                        const angle = Math.atan2(fy, fx);
                        const x2 = x + Math.cos(angle) * scale;
                        const y2 = y + Math.sin(angle) * scale;
                        
                        ctx.beginPath();
                        ctx.moveTo(x, y);
                        ctx.lineTo(x2, y2);
                        ctx.strokeStyle = 'rgba(200,200,200,0.08)';
                        ctx.lineWidth = 1;
                        ctx.stroke();
                    }
                }
            }
            ctx.restore();
        }

        const canvas = document.getElementById('simulationCanvas');
        const ctx = canvas.getContext('2d');
        
        function resize() {
            width = window.innerWidth;
            height = window.innerHeight;
            canvas.width = width;
            canvas.height = height;
        }
        
        function initSimulation() {
            resize();
            window.addEventListener('resize', resize);
            
            // Eventos de mouse
            canvas.addEventListener('mousemove', (e) => {
                mouse.x = e.clientX;
                mouse.y = e.clientY;
                mouse.active = true;
            });
            
            canvas.addEventListener('mouseleave', () => {
                mouse.active = false;
            });
            
            // Crear distribuci√≥n inicial en espiral
            for (let i = 0; i < PHYSICS.N_ATTRACTORS; i++) {
                particles.push(new Planetesimal('attractor'));
            }
            for (let i = 0; i < PHYSICS.N_REPULSORS; i++) {
                particles.push(new Planetesimal('repulsor'));
            }
            
            updateStats();
            animate();
        }
        
        function updateStats() {
            const attractors = particles.filter(p => p.type === 'attractor').length;
            const repulsors = particles.filter(p => p.type === 'repulsor').length;
            document.getElementById('particleCount').textContent = particles.length;
            document.getElementById('attractorCount').textContent = attractors;
            document.getElementById('repulsorCount').textContent = repulsors;
            document.getElementById('collisionCount').textContent = collisionCounter;
        }
        
        function animate() {
            frameCount++;
            
            // Fondo con trazo sutil (rastro)
            ctx.fillStyle = 'rgba(255, 255, 255, 0.15)';
            ctx.fillRect(0, 0, width, height);
            
            // Dibujar campo vectorial sutil
            if (frameCount % 3 === 0) { // Optimizaci√≥n: cada 3 frames
                drawField(ctx);
            }
            
            // Actualizar f√≠sica
            particles.forEach(p => p.update(particles));
            
            // Manejar colisiones
            handleCollisions();
            
            // Dibujar conexiones (constelaciones)
            drawConnections(ctx);
            
            // Dibujar part√≠culas
            particles.forEach(p => p.draw(ctx));
            
            // Actualizar stats cada 60 frames
            if (frameCount % 60 === 0) updateStats();
            
            requestAnimationFrame(animate);
        }

        // ==========================================
        // CHATBOT DECOHERENCEXXIII - VERSI√ìN OFICIAL
        // Basado en manual v3 - Estructura de √Årbol
        // ==========================================
        
        // Variables de sesi√≥n seg√∫n manual
        let sessionVars = {
            motivo_contacto: '',
            nombre_usuario: '',
            plan_seleccionado: '',
            opciones_recorridas: [],
            info_ingresada: ''
        };

        const chatData = {
            nodes: {
                // ==========================================
                // 0. BIENVENIDA E IDENTIFICACI√ìN
                // ==========================================
                '0': {
                    message: "Hola, bienvenido/a al asistente de DECOHERENCEXXIII.\n\nSoy tu asistente virtual. Puedo resolver todas tus dudas informativas sobre membres√≠as, planes, f√≥rmulas, asesor√≠as y m√°s.\n\n¬øEn qu√© te puedo ayudar hoy?",
                    options: [
                        { text: "1 Mi Membres√≠a", next: '1', desc: "Informaci√≥n del plan, Plan de Alimentaci√≥n, cambio, distancia" },
                        { text: "2 Mis Sesiones y Agenda", next: '2', desc: "Agendar, reagendar, cancelar, transferir sesiones" },
                        { text: "3 Mis F√≥rmulas", next: '3', desc: "INSULESTERON, f√≥rmula personalizada, advertencias" },
                        { text: "4 Asesor√≠as y Seguimiento", next: '4', desc: "Audiograma, planes de alimentaci√≥n y conductual, checks" },
                        { text: "5 An√°lisis y Resultados", next: '5', desc: "Composici√≥n corporal, agendar, interpretar resultados" },
                        { text: "6 Tarjeta de Miembros", next: '6', desc: "Funcionamiento, negocios con descuento" },
                        { text: "7 Pagos y Renovaci√≥n", next: '7', desc: "Reportar pago, solicitar link, problemas", escalate: true, motive: "Men√∫ pagos" },
                        { text: "8 Embajadores", next: '8', desc: "Programa de embajadores" },
                        { text: "9 Informaci√≥n General", next: '9', desc: "Filosof√≠a, ubicaci√≥n, comparar planes" },
                        { text: "10 Agente Humano", next: '10', desc: "Escalar a WhatsApp Oficial", escalate: true, motive: "Escalado directo" },
                        { text: "11 Sitio Web - Botones", next: '11', desc: "Descripci√≥n de los 12 botones del Sitio" },
                        { text: "12 ¬øC√≥mo hago...?", next: '12', desc: "Dudas frecuentes paso a paso" }
                    ]
                },

                // ==========================================
                // 1. MI MEMBRES√çA
                // ==========================================
                '1': {
                    message: "¬øQu√© necesitas saber sobre tu membres√≠a?",
                    options: [
                        { text: "1.1 Qu√© incluye mi membres√≠a", next: '1.1' },
                        { text: "1.2 Plan de Alimentaci√≥n", next: '1.2' },
                        { text: "1.3 Cambiar de plan", next: '1.3', escalate: true, motive: "Cambio de plan" },
                        { text: "1.4 Membres√≠a a distancia", next: '1.4', escalate: true, motive: "Membres√≠a a distancia" },
                        { text: "‚Üê Volver al men√∫ principal", next: '0' }
                    ]
                },
                '1.1': {
                    message: "Selecciona tu plan para ver detalles:",
                    options: [
                        { text: "Syntheseis Basic $350", next: '1.1.1' },
                        { text: "Syntheseis Unique $650", next: '1.1.2' },
                        { text: "DX B√°sico $750", next: '1.1.3' },
                        { text: "DX Premium $1,200", next: '1.1.4' },
                        { text: "‚Üê Volver", next: '1' }
                    ]
                },
                '1.1.1': {
                    message: "**Syntheseis Basic - $350/mes**\n\nIncluye:\n‚Ä¢ INSULESTERON 300g mensual\n‚Ä¢ An√°lisis de composici√≥n corporal\n‚Ä¢ 1 asesor√≠a v√≠a Audiograma\n‚Ä¢ Plan Metab√≥lico-Conductual\n‚Ä¢ Plan de Alimentaci√≥n\n‚Ä¢ Suero Oral\n‚Ä¢ Tarjeta de Miembros\n\nIdeal para inicio con seguimiento digital.",
                    options: [{ text: "‚Üê Volver a planes", next: '1.1' }]
                },
                '1.1.2': {
                    message: "**Syntheseis Unique - $650/mes**\n\nIncluye:\n‚Ä¢ F√≥rmula personalizada (300g)\n‚Ä¢ 1 Sesi√≥n Aparatolog√≠a Facial\n‚Ä¢ An√°lisis composici√≥n corporal\n‚Ä¢ 2 asesor√≠as v√≠a Audiograma\n‚Ä¢ Calculadoras y Test interactivos\n‚Ä¢ Sitio Web de Seguimiento personalizado\n‚Ä¢ Plan Metab√≥lico-Conductual\n‚Ä¢ Plan de Alimentaci√≥n\n‚Ä¢ Suero Oral\n‚Ä¢ Tarjeta de Miembros",
                    options: [{ text: "‚Üê Volver a planes", next: '1.1' }]
                },
                '1.1.3': {
                    message: "**DX B√°sico - $750/mes**\n\nIncluye:\n‚Ä¢ INSULESTERON\n‚Ä¢ 3 Sesiones de Aparatolog√≠a\n‚Ä¢ Drenaje + Back Facial\n‚Ä¢ An√°lisis composici√≥n corporal\n‚Ä¢ Asesor√≠as semanales\n‚Ä¢ Calculadoras + Sitio Web\n‚Ä¢ Plan Metab√≥lico + Alimentaci√≥n\n‚Ä¢ Suero Oral + Tarjeta",
                    options: [{ text: "‚Üê Volver a planes", next: '1.1' }]
                },
                '1.1.4': {
                    message: "**DX Premium - $1,200/mes**\n\nIncluye:\n‚Ä¢ F√≥rmula personalizada (300g)\n‚Ä¢ 4 Sesiones transferibles a terceros\n‚Ä¢ Tattoos y Masajes\n‚Ä¢ 1 sesi√≥n Estimulaci√≥n Capilar\n‚Ä¢ An√°lisis + Dieta personalizada\n‚Ä¢ Asesor√≠as semanales\n‚Ä¢ Calculadoras + Sitio Web\n‚Ä¢ Plan Conductual + Alimentaci√≥n\n‚Ä¢ Suero Oral + Tarjeta\n\n‚ö†Ô∏è Sesiones transferibles: requieren coordinaci√≥n previa.",
                    options: [{ text: "‚Üê Volver a planes", next: '1.1' }]
                },
                '1.2': {
                    message: "**Plan de Alimentaci√≥n**\n\nAccede desde tu Sitio Web ‚Üí Panel de Control ‚Üí Plan de Alimentaci√≥n.\n\n‚ö†Ô∏è **IMPORTANTE**: El sistema NO guarda PDFs. Debes descargar inmediatamente al generar. Si no descargas, deber√°s regenerar.\n\n¬øPrefieres que lo generemos nosotros por ti?",
                    options: [
                        { text: "üì± S√≠, generar por m√≠", escalate: true, motive: "Generar Plan Alimentaci√≥n" },
                        { text: "‚Üê Volver", next: '1' }
                    ]
                },
                '1.3': {
                    message: "Para cambiar de plan necesitamos atenci√≥n personalizada.\n\nTe enviar√© a WhatsApp Oficial con tu informaci√≥n pre-cargada.",
                    options: [{ text: "üì± Contactar asesor", escalate: true, motive: "Cambio de plan" }]
                },
                '1.4': {
                    message: "**Membres√≠a a Distancia**\n\n‚Ä¢ 10% de descuento sobre precio regular\n‚Ä¢ Incluye: F√≥rmulas con env√≠o, Asesor√≠as Audiograma, Planes, Sitio Web, Tarjeta digital\n‚Ä¢ NO incluye sesiones presenciales (aparatolog√≠a, masajes, etc.)\n\n¬øTe interesa adquirirla?",
                    options: [
                        { text: "üì± S√≠, quiero adquirir", escalate: true, motive: "Membres√≠a a distancia" },
                        { text: "‚Üê Volver", next: '1' }
                    ]
                },

                // ==========================================
                // 2. SESIONES Y AGENDA
                // ==========================================
                '2': {
                    message: "¬øQu√© necesitas con tus sesiones?\n\n‚ö†Ô∏è **Pol√≠tica**: Reagendamiento/cancelaci√≥n requiere +24h de anticipaci√≥n. Menos de 24h = sesi√≥n realizada.",
                    options: [
                        { text: "2.1 Agendar sesi√≥n", next: '2.1', escalate: true, motive: "Agendar sesi√≥n" },
                        { text: "2.2 Reagendar sesi√≥n", next: '2.2', escalate: true, motive: "Reagendar cita" },
                        { text: "2.3 Cancelar sesi√≥n", next: '2.3', escalate: true, motive: "Cancelar cita" },
                        { text: "2.4 Transferir sesi√≥n (Premium)", next: '2.4', escalate: true, motive: "Transferir sesi√≥n" },
                        { text: "2.5 ¬øCu√°ntas sesiones me quedan?", next: '2.5' },
                        { text: "‚Üê Volver al men√∫ principal", next: '0' }
                    ]
                },
                '2.1': {
                    message: "Para agendar necesitamos coordinar fecha y hora.\n\nSesiones disponibles seg√∫n tu plan:\n‚Ä¢ Unique: 1 sesi√≥n Aparatolog√≠a\n‚Ä¢ DX B√°sico: 3 sesiones (Aparatolog√≠a, Drenaje, Back)\n‚Ä¢ DX Premium: 4 sesiones + Capilar + Masaje + Tattoo",
                    options: [{ text: "üì± Agendar ahora", escalate: true, motive: "Agendar sesi√≥n" }]
                },
                '2.2': {
                    message: "‚ö†Ô∏è **Pol√≠tica de reagendamiento**: Debes solicitar con +24h de anticipaci√≥n.\n\nEscr√≠benos al WhatsApp Oficial con tu nombre y nueva fecha preferida.",
                    options: [{ text: "üì± Reagendar ahora", escalate: true, motive: "Reagendar cita" }]
                },
                '2.3': {
                    message: "‚ö†Ô∏è **Pol√≠tica de cancelaci√≥n**: <24h de anticipaci√≥n = sesi√≥n realizada (se descuenta).\n\n¬øPrefieres reagendar en lugar de cancelar?",
                    options: [
                        { text: "S√≠, prefiero reagendar", next: '2.2' },
                        { text: "No, confirmar cancelaci√≥n", escalate: true, motive: "Cancelar cita" },
                        { text: "‚Üê Volver", next: '2' }
                    ]
                },
                '2.4': {
                    message: "**Transferencia de sesiones (DX Premium)**\n\nPara transferir necesito:\n‚Ä¢ Nombre completo del beneficiario\n‚Ä¢ WhatsApp del beneficiario\n\nEl beneficiario deber√° contactar al 5535691939 directamente para agendar.\n\n‚ö†Ô∏è Sujeto a pol√≠tica de +24h de anticipaci√≥n.",
                    options: [{ text: "üì± Proceder con transferencia", escalate: true, motive: "Transferir sesi√≥n" }]
                },
                '2.5': {
                    message: "Consulta tus sesiones disponibles en:\n**Sitio Web ‚Üí Calendario Sugerido**\n\nSeg√∫n tu plan:\n‚Ä¢ Basic: 0 sesiones\n‚Ä¢ Unique: 1 sesi√≥n\n‚Ä¢ DX B√°sico: 3 sesiones\n‚Ä¢ DX Premium: 4 sesiones + extras\n\n¬øNo tienes acceso al Sitio Web?",
                    options: [
                        { text: "üì± No tengo acceso", escalate: true, motive: "Recuperar acceso Sitio Web" },
                        { text: "‚Üê Volver", next: '2' }
                    ]
                },

                // ==========================================
                // 3. F√ìRMULAS
                // ==========================================
                '3': {
                    message: "¬øQu√© necesitas sobre tus f√≥rmulas?",
                    options: [
                        { text: "3.1 ¬øQu√© es INSULESTERON?", next: '3.1' },
                        { text: "3.2 ¬øC√≥mo se prepara?", next: '3.2' },
                        { text: "3.3 Mi f√≥rmula personalizada", next: '3.3' },
                        { text: "3.4 Cambiar objetivos de f√≥rmula", next: '3.4', escalate: true, motive: "Actualizar f√≥rmula" },
                        { text: "3.5 Advertencias e interacciones", next: '3.5' },
                        { text: "‚Üê Volver al men√∫ principal", next: '0' }
                    ]
                },
                '3.1': {
                    message: "**INSULESTERON**\n\nPolvo para preparar bebidas. Beneficios:\n‚Ä¢ Estabilidad metab√≥lica\n‚Ä¢ Colesterol equilibrado\n‚Ä¢ Antioxidante natural\n‚Ä¢ Antiinflamatorio\n‚Ä¢ Soporte inmunol√≥gico\n‚Ä¢ Energ√≠a sostenida\n\n‚ö†Ô∏è **No es suplemento alimenticio ni tiene uso terap√©utico.**",
                    options: [{ text: "‚Üê Volver", next: '3' }]
                },
                '3.2': {
                    message: "**Preparaci√≥n**\n\nPresentaci√≥n: 300g en polvo\n\n1. Disuelve en agua, jugo, caf√© o bebida de preferencia\n2. Respeta la dosis indicada en tu Plan Conductual\n3. Momento ideal de consumo tambi√©n est√° en tu plan\n\nConservar en lugar fresco, seco y sin luz directa.",
                    options: [{ text: "‚Üê Volver", next: '3' }]
                },
                '3.3': {
                    message: "**F√≥rmula Personalizada** (Unique/Premium)\n\nProceso de creaci√≥n:\n1. Evaluamos tus objetivos y gustos\n2. Seleccionamos ingredientes activos espec√≠ficos\n3. Recibes mensualmente en polvo (300g)\n\n¬øNo has recibido tu f√≥rmula personalizada?",
                    options: [
                        { text: "üì± No la he recibido", escalate: true, motive: "F√≥rmula no recibida" },
                        { text: "Tengo dudas sobre mi f√≥rmula", escalate: true, motive: "Duda f√≥rmula personalizada" },
                        { text: "‚Üê Volver", next: '3' }
                    ]
                },
                '3.4': {
                    message: "Para actualizar tu f√≥rmula indica:\n‚Ä¢ Nuevo objetivo (ej: m√°s energ√≠a, control glucosa, etc.)\n‚Ä¢ Si deseas cambiar presentaci√≥n o sabor\n\nEscr√≠benos antes de tu pr√≥xima entrega programada.",
                    options: [{ text: "üì± Solicitar cambio", escalate: true, motive: "Actualizar f√≥rmula" }]
                },
                '3.5': {
                    message: "**‚ö†Ô∏è ADVERTENCIAS E INTERACCIONES**\n\n**Contraindicaciones:**\n‚Ä¢ No menores de 18 a√±os\n‚Ä¢ No embarazo ni lactancia\n‚Ä¢ Conservar en lugar fresco, seco, sin luz\n‚Ä¢ No consumir si sello est√° roto\n\n**üíä Consulta m√©dico si tomas:**\n‚Ä¢ Antidiab√©ticos o insulina\n‚Ä¢ Antihipertensivos\n‚Ä¢ Anticoagulantes\n‚Ä¢ Medicamentos hep√°ticos\n\n‚ö†Ô∏è No sustituye atenci√≥n m√©dica profesional.",
                    options: [{ text: "‚Üê Volver", next: '3' }]
                },

                // ==========================================
                // 4. ASESOR√çAS Y SEGUIMIENTO
                // ==========================================
                '4': {
                    message: "¬øQu√© necesitas de asesor√≠as?",
                    options: [
                        { text: "4.1 Solicitar asesor√≠a", next: '4.1' },
                        { text: "4.2 ¬øC√≥mo funciona el Audiograma?", next: '4.2' },
                        { text: "4.3 Plan de Alimentaci√≥n", next: '4.3' },
                        { text: "4.4 Plan Conductual", next: '4.4' },
                        { text: "4.5 Check Diario", next: '4.5' },
                        { text: "‚Üê Volver al men√∫ principal", next: '0' }
                    ]
                },
                '4.1': {
                    message: "**Solicitar Asesor√≠a**\n\n1. Ingresa a tu Sitio Web\n2. Bot√≥n 'Solicitar Asesor√≠a'\n3. Describe tu consulta\n4. Env√≠a\n\nüìÖ **Entregas: DOMINGOS**\n‚ö†Ô∏è Solicita antes del domingo para incluirte esa semana.\n\nEl servicio es informativo/educativo. No sustituye consulta m√©dica.",
                    options: [
                        { text: "üì± No tengo acceso al Sitio", escalate: true, motive: "Recuperar acceso Sitio Web" },
                        { text: "‚Üê Volver", next: '4' }
                    ]
                },
                '4.2': {
                    message: "**Audiograma = Audio con an√°lisis personalizado**\n\nVentajas:\n‚Ä¢ Escucha cuantas veces quieras\n‚Ä¢ Cons√©rvalo en tu dispositivo\n‚Ä¢ Comp√°rtelo si lo deseas\n‚Ä¢ Contexto profundo vs texto breve\n\nüìÖ Entregas cada DOMINGO para quienes solicitaron durante la semana.\n\n‚ö†Ô∏è Fines informativos/educativos √∫nicamente.",
                    options: [{ text: "‚Üê Volver", next: '4' }]
                },
                '4.3': {
                    message: "**Plan de Alimentaci√≥n**\n\nAccede: Sitio Web ‚Üí Panel de Control ‚Üí Plan de Alimentaci√≥n\n\n‚ö†Ô∏è **CR√çTICO**: El sistema NO guarda PDFs. Al generar, DESCARGA INMEDIATAMENTE. Si no descargas, deber√°s regenerar.\n\n¬øNecesitas que lo generemos nosotros?",
                    options: [
                        { text: "üì± S√≠, generar por m√≠", escalate: true, motive: "Generar Plan Alimentaci√≥n" },
                        { text: "‚Üê Volver", next: '4' }
                    ]
                },
                '4.4': {
                    message: "**Plan Conductual**\n\nArticula todos los elementos:\n‚Ä¢ F√≥rmulas (cu√°ndo/tomar)\n‚Ä¢ Asesor√≠as (seguimiento)\n‚Ä¢ An√°lisis (medici√≥n)\n‚Ä¢ Sesiones (aparatolog√≠a)\n\nEstrategia de h√°bitos para adherencia y resultados medibles.\n\nAcceso: Sitio Web ‚Üí Panel de Control ‚Üí Plan Conductual\n‚ö†Ô∏è Descarga PDF inmediato (no guarda versiones).",
                    options: [
                        { text: "üì± Generar/Actualizar por m√≠", escalate: true, motive: "Generar Plan Conductual" },
                        { text: "‚Üê Volver", next: '4' }
                    ]
                },
                '4.5': {
                    message: "**Check List Metab√≥lico-Conductual Diario**\n\nUbicaci√≥n: Sitio Web ‚Üí Check List Diario\n\nDebes llenarlo antes de finalizar el d√≠a. Sirve para:\n‚Ä¢ An√°lisis diario de tu conducta\n‚Ä¢ Auto-observaci√≥n de h√°bitos\n‚Ä¢ Optimizar personalizaci√≥n del programa\n‚Ä¢ Datos para mejorar acompa√±amiento\n\n‚ö†Ô∏è La constancia en el Check List permite que tu Plan Conductual evolucione preciso contigo.",
                    options: [
                        { text: "4.5.1 ¬øD√≥nde lo hago?", next: '4.5.1' },
                        { text: "4.5.2 No s√© usarlo", next: '4.5.2' },
                        { text: "4.5.3 Problema t√©cnico", next: '4.5.3', escalate: true, motive: "Problema t√©cnico Check List" },
                        { text: "‚Üê Volver", next: '4' }
                    ]
                },
                '4.5.1': {
                    message: "Sitio Web ‚Üí Check List Metab√≥lico-Conductual Diario\n\nSi no tienes acceso al Sitio Web, solic√≠talo:",
                    options: [{ text: "üì± Solicitar acceso", escalate: true, motive: "Recuperar acceso Sitio Web" }]
                },
                '4.5.2': {
                    message: "El Check List contiene acciones de tu Plan Conductual. Confirma cu√°les realizaste cada d√≠a.\n\nEsto permite acompa√±amiento preciso y medici√≥n de adherencia.\n\n¬øNecesitas gu√≠a la primera vez?",
                    options: [{ text: "üì± S√≠, solicitar gu√≠a", escalate: true, motive: "Gu√≠a Check List" }]
                },
                '4.5.3': {
                    message: "Indica tu nombre completo y describe el problema t√©cnico. Te atenderemos a la brevedad.",
                    options: [{ text: "üì± Reportar problema", escalate: true, motive: "Problema t√©cnico Check List" }]
                },

                // ==========================================
                // 5. AN√ÅLISIS Y RESULTADOS
                // ==========================================
                '5': {
                    message: "¬øQu√© necesitas de an√°lisis?",
                    options: [
                        { text: "5.1 ¬øQu√© es el an√°lisis de composici√≥n corporal?", next: '5.1' },
                        { text: "5.2 Agendar an√°lisis", next: '5.2', escalate: true, motive: "Agendar evaluaci√≥n" },
                        { text: "5.3 Ver mis resultados", next: '5.3' },
                        { text: "‚Üê Volver al men√∫ principal", next: '0' }
                    ]
                },
                '5.1': {
                    message: "**An√°lisis de Composici√≥n Corporal**\n\nTecnolog√≠a: BIOIMPEDANCIA (m√©dica certificada)\n\nMide:\n‚Ä¢ Masa grasa y magra\n‚Ä¢ Metabolismo basal\n‚Ä¢ Grasa visceral\n‚Ä¢ IMC\n‚Ä¢ Edad corporal\n\n**Momentos clave:**\n‚Ä¢ **Inicio**: Dise√±a tu plan personalizado\n‚Ä¢ **Cierre**: Mide progreso vs inicio\n\nBase cient√≠fica de todo el programa.",
                    options: [{ text: "‚Üê Volver", next: '5' }]
                },
                '5.2': {
                    message: "¬øQu√© tipo de evaluaci√≥n necesitas?",
                    options: [
                        { text: "Inicial (nuevo miembro)", escalate: true, motive: "Agendar evaluaci√≥n inicial" },
                        { text: "Cierre (por vencer membres√≠a)", escalate: true, motive: "Agendar evaluaci√≥n cierre" },
                        { text: "Intermedia (extra)", escalate: true, motive: "Agendar evaluaci√≥n intermedia" },
                        { text: "‚Üê Volver", next: '5' }
                    ]
                },
                '5.3': {
                    message: "Consulta resultados en:\n**Sitio Web ‚Üí Mi Dashboard**\n\nVer√°s hist√≥rico de mediciones y gr√°ficas de evoluci√≥n.\n\n¬øNo recibiste tus resultados?",
                    options: [
                        { text: "üì± No recib√≠ resultados", escalate: true, motive: "No recib√≠ resultados an√°lisis" },
                        { text: "Quiero interpretaci√≥n detallada", next: '5.3.1' },
                        { text: "‚Üê Volver", next: '5' }
                    ]
                },
                '5.3.1': {
                    message: "La interpretaci√≥n detallada de resultados se realiza en la **asesor√≠a del domingo**.\n\nSolicita asesor√≠a esta semana en tu Sitio Web.",
                    options: [{ text: "üì± Solicitar asesor√≠a", escalate: true, motive: "Solicitar asesor√≠a interpretaci√≥n" }]
                },

                // ==========================================
                // 6. TARJETA DE MIEMBROS
                // ==========================================
                '6': {
                    message: "¬øQu√© necesitas de tu Tarjeta de Miembros?",
                    options: [
                        { text: "6.1 ¬øC√≥mo funciona?", next: '6.1' },
                        { text: "6.2 Ver negocios con descuento", next: '6.2' },
                        { text: "6.3 No la he recibido", next: '6.3', escalate: true, motive: "No recib√≠ tarjeta" },
                        { text: "‚Üê Volver al men√∫ principal", next: '0' }
                    ]
                },
                '6.1': {
                    message: "**Tarjeta de Miembros**\n\nBeneficio: Descuentos en negocios locales de Coacalco.\n\n‚úÖ V√°lida √∫nicamente con membres√≠a activa\n‚úÖ Aplica en negocios participantes de la zona\n‚úÖ Se renueva autom√°ticamente al renovar membres√≠a\n‚ö†Ô∏è Si vence membres√≠a, se suspende hasta renovaci√≥n",
                    options: [{ text: "‚Üê Volver", next: '6' }]
                },
                '6.2': {
                    message: "Consulta el directorio actualizado en:\n**Sitio Web ‚Üí Descuentos en Negocios**\n\nO solic√≠talo por WhatsApp:",
                    options: [{ text: "üì± Solicitar directorio", escalate: true, motive: "Consultar negocios descuento" }]
                },

                // ==========================================
                // 7. PAGOS (ESCALA DIRECTO - NO INFORMATIVO)
                // ==========================================
                '7': {
                    message: "Los temas de pago requieren atenci√≥n directa para seguridad de tu informaci√≥n.\n\nTe conecto con WhatsApp Oficial:",
                    options: [{ text: "üì± Abrir WhatsApp", escalate: true, motive: "Consulta pagos" }]
                },

                // ==========================================
                // 8. EMBAJADORES
                // ==========================================
                '8': {
                    message: "¬øTe interesa generar ingresos recomendando DECOHERENCEXXIII?",
                    options: [
                        { text: "8.1 ¬øC√≥mo funciona el programa?", next: '8.1' },
                        { text: "8.2 Quiero ser embajador", next: '8.2', escalate: true, motive: "Registro embajador" },
                        { text: "8.3 Dudas sobre red/comisiones", next: '8.3', escalate: true, motive: "Consulta red embajador" },
                        { text: "‚Üê Volver al men√∫ principal", next: '0' }
                    ]
                },
                '8.1': {
                    message: "**Programa de Embajadores**\n\nGenera ingreso pasivo recurrente:\n\n1. Recomiendas a alguien de confianza\n2. Se une a tu red de embajadores\n3. Lo fidelizamos y motivamos a que recomiende\n4. Tu red crece = comisiones recurrentes\n5. Todo comienza con recomendar UNA persona\n\nDisponible para Coacalco y alrededores.",
                    options: [{ text: "‚Üê Volver", next: '8' }]
                },
                '8.2': {
                    message: "¬°Excelente decisi√≥n! Para registrarte necesitamos tus datos completos.",
                    options: [{ text: "üì± Registrarme como embajador", escalate: true, motive: "Registro embajador" }]
                },
                '8.3': {
                    message: "Para consultar estado de red, referidos activos o comisiones pendientes, cont√°ctanos directamente.",
                    options: [{ text: "üì± Consultar mi red", escalate: true, motive: "Consulta red embajador" }]
                },

                // ==========================================
                // 9. INFORMACI√ìN GENERAL
                // ==========================================
                '9': {
                    message: "¬øQu√© informaci√≥n necesitas?",
                    options: [
                        { text: "9.1 Filosof√≠a y marco legal", next: '9.1' },
                        { text: "9.2 Comparar planes", next: '9.2' },
                        { text: "9.3 Ubicaci√≥n y contacto", next: '9.3' },
                        { text: "‚Üê Volver al men√∫ principal", next: '0' }
                    ]
                },
                '9.1': {
                    message: "**Filosof√≠a DECOHERENCEXXIII**\n\nBienestar integral articulando:\n‚Ä¢ Est√©tica facial consciente\n‚Ä¢ Metabolismo y nutrici√≥n\n‚Ä¢ Educaci√≥n cient√≠fica\n‚Ä¢ Formulaciones personalizadas\n\n**Principios:**\n‚Ä¢ Ciencia verificable\n‚Ä¢ Cero especulaci√≥n\n‚Ä¢ Ingredientes naturales transparentes\n‚Ä¢ Educaci√≥n como herramienta de cambio\n\n‚ö†Ô∏è **Marco legal**: Ning√∫n producto tiene uso terap√©utico ni sustituye atenci√≥n m√©dica profesional.",
                    options: [{ text: "‚Üê Volver", next: '9' }]
                },
                '9.2': {
                    message: "**Comparaci√≥n de Planes**\n\n**Syntheseis Basic** $350\nINSULESTERON + Planes digitales\n\n**Syntheseis Unique** $650\nF√≥rmula personalizada + 1 sesi√≥n facial\n\n**DX B√°sico** $750\n3 sesiones + asesor√≠as semanales\n\n**DX Premium** $1,200\n4 sesiones transferibles + dieta personalizada\n\n¬øNecesitas ayuda para elegir?",
                    options: [{ text: "üì± S√≠, contactar asesor", escalate: true, motive: "Asesor√≠a elecci√≥n plan" }]
                },
                '9.3': {
                    message: "**Ubicaci√≥n**\nCoacalco de Berrioz√°bal, Estado de M√©xico\n\n**Cobertura a domicilio:**\nCoacalco, Ecatepec, Tultitl√°n, Tultepec, Cuautitl√°n y zonas cercanas.\n\n**WhatsApp Oficial:** 55 3569 1939\n\n¬øDeseas coordinar una visita?",
                    options: [{ text: "üì± Coordinar visita", escalate: true, motive: "Coordinar visita" }]
                },

                // ==========================================
                // 10. AGENTE HUMANO (ESCALADO)
                // ==========================================
                '10': {
                    message: "Entiendo que prefieres hablar con un asesor humano.\n\nEn un momento te atenderemos en:\n**WhatsApp Oficial: 55 3569 1939**\n\nHorario: Lunes a Domingo\n\nTu conversaci√≥n aqu√≠ ser√° enviada para contexto.",
                    options: [{ text: "üì± Chatear ahora", escalate: true, motive: "Escalado directo a agente" }]
                },

                // ==========================================
                // 11. SITIO WEB - BOTONES DOCUMENTADOS
                // ==========================================
                '11': {
                    message: "**Sitio Web de Seguimiento ‚Äî Gu√≠a de Botones**\n\nSelecciona el bot√≥n sobre el que tienes dudas:",
                    options: [
                        { text: "11.1 Panel de Control", next: '11.1' },
                        { text: "11.2 Mi Dashboard", next: '11.2' },
                        { text: "11.3 Solicitar Asesor√≠a", next: '11.3' },
                        { text: "11.4 Descuentos en Negocios", next: '11.4' },
                        { text: "11.5 Juega Aprende y Gana", next: '11.5' },
                        { text: "11.6 Recetas", next: '11.6' },
                        { text: "11.7 An√°lisis y Test", next: '11.7' },
                        { text: "11.8 Calendario Sugerido", next: '11.8' },
                        { text: "11.9 Check List Diario", next: '11.9' },
                        { text: "11.10 Contenido Valioso", next: '11.10' },
                        { text: "11.11 Cambiar H√°bitos", next: '11.11' },
                        { text: "11.12 Actividad F√≠sica", next: '11.12' },
                        { text: "‚Üê Volver al men√∫ principal", next: '0' }
                    ]
                },
                '11.1': {
                    message: "**Panel de Control**\n\nAqu√≠ gestionas tus planes personalizados:\n\n‚Ä¢ **Plan Alimentaci√≥n**: Crear/actualizar. ‚ö†Ô∏è Descarga PDF inmediato (no guarda)\n‚Ä¢ **Plan Conductual**: Estrategia h√°bitos. ‚ö†Ô∏è Descarga PDF inmediato\n‚Ä¢ **Metabolismo y Cuidado Facial**: Sistema interactivo salud-piel-metabolismo\n‚Ä¢ **Toma de Decisiones**: Entrena razonamiento conductual\n‚Ä¢ **Prevenci√≥n Fallo Terap√©utico**: Previene h√°bitos contradictorios",
                    options: [{ text: "‚Üê Volver a botones", next: '11' }]
                },
                '11.2': {
                    message: "**Mi Dashboard**\n\nVisualizaci√≥n de tu evoluci√≥n:\n‚Ä¢ Hist√≥rico mediciones fisiol√≥gicas\n‚Ä¢ Gr√°ficas de h√°bitos y adherencia\n‚Ä¢ Comparaci√≥n temporal de progreso\n\nEspacio ideal para revisar avances y mantener constancia motivada.",
                    options: [{ text: "‚Üê Volver a botones", next: '11' }]
                },
                '11.3': {
                    message: "**Solicitar Asesor√≠a**\n\nCanal para consultar cualquier tema:\n‚Ä¢ Nutrici√≥n y h√°bitos alimenticios\n‚Ä¢ Actividad f√≠sica y metabolismo\n‚Ä¢ Dudas sobre el programa\n‚Ä¢ Seguimiento personalizado\n\n‚ö†Ô∏è **IMPORTANTE**: Los Audiogramas se entregan los DOMINGOS. Debes solicitar antes para incluirte esa semana.",
                    options: [{ text: "‚Üê Volver a botones", next: '11' }]
                },
                '11.4': {
                    message: "**Descuentos en Negocios**\n\nDirectorio de aliados en Coacalco:\n1. Consulta men√∫ de descuentos disponibles\n2. Presenta tu Tarjeta de Miembro f√≠sica\n3. Solicita la promoci√≥n indicada en men√∫\n\n‚úÖ V√°lido durante vigencia de membres√≠a",
                    options: [{ text: "‚Üê Volver a botones", next: '11' }]
                },
                '11.5': {
                    message: "**Juega, Aprende y Gana Regalos**\n\nüéÆ **Aprender**: Interioriza conocimientos sobre salud y metabolismo de forma din√°mica\nüéÅ **Ganar**: Completa puntos acumulables = elige tu regalo\n\nRecompensa por educarte en salud.",
                    options: [{ text: "‚Üê Volver a botones", next: '11' }]
                },
                '11.6': {
                    message: "**Recetas**\n\nRecetario saludable alineado a tus planes:\n‚Ä¢ Pr√°cticas y saludables\n‚Ä¢ Variedad sin salirte del plan\n‚Ä¢ Complementan objetivos metab√≥licos\n\nHace tu Plan de Alimentaci√≥n m√°s disfrutable y sostenible.",
                    options: [{ text: "‚Üê Volver a botones", next: '11' }]
                },
                '11.7': {
                    message: "**An√°lisis y Test ‚Äî Herramientas interactivas**\n\n‚Ä¢ **Calculadoras**: Indicadores de salud personalizados\n‚Ä¢ **Riesgos Salud**: Factores de riesgo seg√∫n tus datos\n‚Ä¢ **Impacto Microbiota**: C√≥mo alimentos afectan tu microbiota\n‚Ä¢ **Contador Calor√≠as**: Estima aporte cal√≥rico\n\nInformaci√≥n educativa complementaria a tu plan.",
                    options: [{ text: "‚Üê Volver a botones", next: '11' }]
                },
                '11.8': {
                    message: "**Calendario Sugerido**\n\nRecomendaciones para:\n‚Ä¢ Horarios √≥ptimos de organizaci√≥n\n‚Ä¢ Control de vigencia de membres√≠a\n‚Ä¢ Fechas clave del programa\n\nGu√≠a para estructurar rutina coherente con Plan Conductual.",
                    options: [{ text: "‚Üê Volver a botones", next: '11' }]
                },
                '11.9': {
                    message: "**Check List Metab√≥lico-Conductual Diario**\n\nLlenar ANTES de finalizar el d√≠a.\n\nSirve para:\n‚Ä¢ An√°lisis diario de tu conducta\n‚Ä¢ Auto-observaci√≥n de h√°bitos\n‚Ä¢ Optimizar personalizaci√≥n del programa\n‚Ä¢ Datos para mejorar acompa√±amiento\n\n‚ö†Ô∏è La constancia permite que tu Plan Conductual evolucione preciso contigo.",
                    options: [{ text: "‚Üê Volver a botones", next: '11' }]
                },
                '11.10': {
                    message: "**Contenido con Alto Valor Informativo**\n\nSelecci√≥n de favoritos del equipo:\n‚Ä¢ Salud y bienestar integral\n‚Ä¢ Estilo de vida consciente\n‚Ä¢ Divulgaci√≥n cient√≠fica verificable\n‚Ä¢ Temas de inter√©s del programa\n\nPara seguir aprendiendo y profundizando.",
                    options: [{ text: "‚Üê Volver a botones", next: '11' }]
                },
                '11.11': {
                    message: "**Quieres Cambiar Definitivamente Alg√∫n H√°bito**\n\nSistema especializado que ofrece:\n‚Ä¢ T√©cnicas y estrategias de cambio de h√°bitos\n‚Ä¢ Informaci√≥n sobre h√°bitos destructivos silenciosos\n‚Ä¢ Herramientas para identificar patrones frenos\n‚Ä¢ Gu√≠a para construir h√°bitos alineados a objetivos\n\nPara cambio conductual real y duradero.",
                    options: [{ text: "‚Üê Volver a botones", next: '11' }]
                },
                '11.12': {
                    message: "**Actividad F√≠sica Consciente**\n\nManual interactivo completo:\n‚Ä¢ Importancia de m√∫sculos para salud integral\n‚Ä¢ T√©cnicas conductuales para no abandonar\n‚Ä¢ Estrategias de constancia en ejercicio\n‚Ä¢ Ejercicios en casa sin equipamiento\n\nEnfoque consciente y sostenible, integrado a Plan Conductual.",
                    options: [{ text: "‚Üê Volver a botones", next: '11' }]
                },

                // ==========================================
                // 12. ¬øC√ìMO HAGO...? (DUDAS FRECUENTES)
                // ==========================================
                '12': {
                    message: "**¬øC√≥mo hago...?** ‚Äî Dudas frecuentes paso a paso",
                    options: [
                        { text: "12.1 Descargar mis planes", next: '12.1' },
                        { text: "12.2 Ver sesiones disponibles", next: '12.2' },
                        { text: "12.3 Solicitar Audiograma", next: '12.3' },
                        { text: "12.4 Ver resultados de an√°lisis", next: '12.4' },
                        { text: "12.5 Hacer Check List diario", next: '12.5' },
                        { text: "12.6 Usar mi Tarjeta de Miembros", next: '12.6' },
                        { text: "12.7 Transferir una sesi√≥n", next: '12.7' },
                        { text: "12.8 Usar calculadoras", next: '12.8' },
                        { text: "‚Üê Volver al men√∫ principal", next: '0' }
                    ]
                },
                '12.1': {
                    message: "**Descargar Plan Alimentaci√≥n/Conductual**\n\n1. Ingresa a tu Sitio Web\n2. Ve a Panel de Control\n3. Selecciona el Plan deseado\n4. Completa la informaci√≥n solicitada\n5. Click en 'Generar Plan'\n6. **DESCARGA EL PDF INMEDIATAMENTE** ‚ö†Ô∏è\n\n‚ö†Ô∏è **CR√çTICO**: El sistema NO guarda versiones. Si no descargas al instante, deber√°s regenerar.\n\n¬øPrefieres que lo generemos nosotros?",
                    options: [
                        { text: "üì± S√≠, generar por m√≠", escalate: true, motive: "Generar Plan" },
                        { text: "‚Üê Volver", next: '12' }
                    ]
                },
                '12.2': {
                    message: "**Ver sesiones disponibles**\n\n**Opci√≥n A** ‚Äî Sitio Web:\n‚Üí Calendario Sugerido\n\n**Opci√≥n B** ‚Äî Seg√∫n tu plan:\n‚Ä¢ Basic: 0 sesiones\n‚Ä¢ Unique: 1 sesi√≥n Aparatolog√≠a\n‚Ä¢ DX B√°sico: 3 sesiones\n‚Ä¢ DX Premium: 4 sesiones + Capilar + Masaje + Tattoo\n\n¬øCu√°ntas te quedan espec√≠ficamente? Escr√≠benos:",
                    options: [{ text: "üì± Consultar saldo", escalate: true, motive: "Consulta sesiones disponibles" }]
                },
                '12.3': {
                    message: "**Solicitar Audiograma**\n\n1. Sitio Web ‚Üí Solicitar Asesor√≠a\n2. Describe tu consulta (nutrici√≥n, h√°bitos, salud, etc.)\n3. Env√≠a solicitud\n\nüìÖ **Entrega: pr√≥ximo DOMINGO**\n‚ö†Ô∏è Solicita antes del domingo para incluirte esa semana\n\nLos Audiogramas son audios personalizados que puedes escuchar cuantas veces quieras.",
                    options: [{ text: "‚Üê Volver", next: '12' }]
                },
                '12.4': {
                    message: "**Ver resultados composici√≥n corporal**\n\n**Opci√≥n A** ‚Äî Sitio Web:\n‚Üí Mi Dashboard ‚Üí hist√≥rico y gr√°ficas\n\n**Opci√≥n B** ‚Äî WhatsApp:\nEscr√≠benos tu nombre completo y te enviamos copia: 55 3569 1939\n\n¬øNecesitas interpretaci√≥n detallada? Solicita asesor√≠a del domingo.",
                    options: [{ text: "‚Üê Volver", next: '12' }]
                },
                '12.5': {
                    message: "**Check List Diario**\n\n1. Sitio Web ‚Üí Check List Metab√≥lico-Conductual Diario\n2. Responde sobre los h√°bitos del d√≠a\n3. Guarda/Env√≠a\n\n**CU√ÅNDO**: Antes de finalizar el d√≠a\n**PARA QU√â**:\n‚Ä¢ Analizas tu conducta\n‚Ä¢ Auto-observaci√≥n de h√°bitos\n‚Ä¢ Personalizamos el programa contigo\n‚Ä¢ Base para adherencia al Plan Conductual",
                    options: [{ text: "‚Üê Volver", next: '12' }]
                },
                '12.6': {
                    message: "**Usar Tarjeta de Miembros**\n\n**F√çSICA**: Se entrega en evaluaci√≥n inicial o primera visita. ¬øNo la tienes? Escr√≠benos: 55 3569 1939\n\n**NEGOCIOS**:\n1. Sitio Web ‚Üí Descuentos en Negocios\n2. Consulta directorio de aliados\n3. Presenta tarjeta f√≠sica en el negocio\n4. Aplica el descuento indicado\n\n‚ö†Ô∏è V√°lida solo con membres√≠a activa",
                    options: [{ text: "‚Üê Volver", next: '12' }]
                },
                '12.7': {
                    message: "**Transferir sesi√≥n (DX Premium)**\n\n1. Reunir datos del beneficiario:\n   - Nombre completo\n   - WhatsApp\n2. Escr√≠benos al 55 3569 1939 para registrar\n3. El beneficiario contacta directo al mismo n√∫mero\n4. Coordina fecha sujeto a pol√≠tica +24h\n\nListo para iniciar transferencia:",
                    options: [{ text: "üì± Abrir WhatsApp", escalate: true, motive: "Transferir sesi√≥n" }]
                },
                '12.8': {
                    message: "**Usar calculadoras**\n\n1. Sitio Web ‚Üí An√°lisis y Test\n2. Elige herramienta:\n   ‚Ä¢ Calculadoras (indicadores salud)\n   ‚Ä¢ Riesgos Salud (factores riesgo)\n   ‚Ä¢ Microbiota (impacto alimentos)\n   ‚Ä¢ Contador Calor√≠as\n3. Ingresa datos solicitados\n4. Lee y guarda resultados\n\nInterpretaci√≥n detallada: Asesor√≠a del domingo.",
                    options: [{ text: "‚Üê Volver", next: '12' }]
                }
            }
        };

        let currentNode = '0';
        const chatMessages = document.getElementById('chatMessages');
        const optionsContainer = document.getElementById('optionsContainer');
        const chatSidebar = document.getElementById('chatSidebar');

        function addMessage(text, isUser = false) {
            const div = document.createElement('div');
            div.className = `flex ${isUser ? 'justify-end' : 'justify-start'} message-bubble`;
            
            // Procesar negritas **texto**
            const formattedText = text.replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>');
            
            div.innerHTML = isUser 
                ? `<div class="bg-neutral-900 text-white px-2.5 py-1.5 rounded-xl rounded-tr-sm text-[11px] max-w-[85%]">${formattedText}</div>`
                : `<div class="bg-white border border-gray-100 text-gray-700 px-3 py-2 rounded-xl rounded-tl-sm text-[11px] max-w-[90%] shadow-sm whitespace-pre-line leading-relaxed">${formattedText}</div>`;
            
            chatMessages.appendChild(div);
            chatMessages.scrollTop = chatMessages.scrollHeight;
            
            // Guardar en historial de sesi√≥n
            if (isUser) {
                sessionVars.opciones_recorridas.push(`Usuario: ${text}`);
            } else {
                sessionVars.opciones_recorridas.push(`Bot: ${text.substring(0, 50)}...`);
            }
        }

        function renderOptions(nodeId) {
            const node = chatData.nodes[nodeId];
            optionsContainer.innerHTML = '';
            
            node.options.forEach(opt => {
                const btn = document.createElement('button');
                btn.className = 'option-btn w-full text-left bg-white/60 hover:bg-white/80 rounded-md text-[11px] text-gray-700 flex items-center justify-between group';
                
                const hasArrow = !opt.text.includes('‚Üê');
                btn.innerHTML = `
                    <span class="truncate pr-2 font-medium">${opt.text}</span>
                    ${hasArrow ? '<svg class="w-3 h-3 opacity-0 group-hover:opacity-100 transition-opacity text-neutral-600 flex-shrink-0" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7"></path></svg>' : ''}
                `;
                
                btn.onclick = () => handleOption(opt);
                optionsContainer.appendChild(btn);
            });
        }

        function handleOption(option) {
            // Guardar selecci√≥n
            sessionVars.opciones_recorridas.push(`Selecci√≥n: ${option.text}`);
            if (option.motive) {
                sessionVars.motivo_contacto = option.motive;
            }

            // Si es escalamiento (casos que NO resuelve el bot)
            if (option.escalate || option.action === 'escalate') {
                const motive = option.motive || sessionVars.motivo_contacto || 'Consulta general';
                openWhatsApp(motive);
                
                // Mostrar mensaje de confirmaci√≥n en chat
                const cleanText = option.text.replace(/[üì±‚Üê]/g, '').trim();
                addMessage(cleanText, true);
                
                addMessage("Te estoy redirigiendo a WhatsApp Oficial (55 3569 1939) con tu informaci√≥n pre-cargada. Solo presiona ENVIAR.");
                return;
            }

            // Mostrar selecci√≥n del usuario
            const cleanText = option.text.replace(/[‚Üê]/g, '').trim();
            addMessage(cleanText, true);

            // Ir al siguiente nodo
            if (option.next) {
                setTimeout(() => {
                    currentNode = option.next;
                    const node = chatData.nodes[currentNode];
                    addMessage(node.message);
                    renderOptions(currentNode);
                }, 300);
            }
        }

        function openWhatsApp(motive) {
            // Construir mensaje pre-redactado seg√∫n manual t√©cnico
            const historial = sessionVars.opciones_recorridas.slice(-5).join(' ‚Üí ');
            
            const mensaje = encodeURIComponent(
                `Hola, soy miembro de DECOHERENCEXXIII. Vengo del chatbot.\n` +
                `‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ\n` +
                `MOTIVO: ${motive}\n` +
                `‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ\n` +
                `DATOS:\n` +
                `${sessionVars.nombre_usuario ? 'Nombre: ' + sessionVars.nombre_usuario + '\n' : ''}` +
                `${sessionVars.plan_seleccionado ? 'Plan: ' + sessionVars.plan_seleccionado + '\n' : ''}` +
                `Recorrido: ${historial}\n` +
                `‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ\n` +
                `Por favor ay√∫denme. ¬°Gracias!`
            );
            
            window.open(`https://wa.me/525535691939?text=${mensaje}`, '_blank');
        }

        function initChat() {
            addMessage(chatData.nodes['0'].message);
            renderOptions('0');
        }

        function minimizeChat() {
            chatSidebar.style.transform = 'translateX(120%)';
            chatSidebar.style.opacity = '0';
            document.getElementById('restoreBtn').style.display = 'flex';
        }

        function restoreChat() {
            chatSidebar.style.transform = 'translateX(0)';
            chatSidebar.style.opacity = '1';
            document.getElementById('restoreBtn').style.display = 'none';
        }
        
        function toggleChat() {
            if (chatSidebar.classList.contains('minimized')) {
                chatSidebar.classList.remove('minimized');
            }
        }

        window.onload = () => {
            initSimulation();
            initChat();
        };
    </script>
</body>
</html>